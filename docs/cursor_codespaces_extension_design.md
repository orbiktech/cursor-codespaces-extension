# Cursor Codespaces Extension Design Document

## Overview

This document describes the full design for a Cursor/VS Code extension that enables seamless SSH-based connections to GitHub Codespaces using the GitHub CLI (`gh`). The goal is to completely automate the hard parts—SSH config management, Codespace selection, startup, and connection—while keeping GitHub authentication secure and user-approved.

---

## Goals

1. Provide a **one-click** “Connect to Codespace” experience.
2. Handle all GitHub CLI calls behind the scenes.
3. Automatically generate and update SSH configuration for Codespaces.
4. Integrate with the Remote-SSH extension to open the Codespace in Cursor.
5. Guide the user only when required (missing tools, insufficient token scopes).
6. Never require manual terminal commands except for GitHub login/token approval.

---

## Key Constraints

- GitHub **does not expose SSH connection info** via a public REST API.
- `gh codespace ssh --config` is the only official, stable way to get SSH settings.
- GitHub authentication scopes must be approved by the user interactively.
- Editing `~/.ssh/config` must be done carefully and securely.

---

## UX Flow Summary

### First-Time Flow

1. User runs “Connect to Codespace”.
2. Extension checks:
   - Is `gh` installed?
   - Is the user authenticated?
   - Are codespaces-related scopes granted?
3. Extension asks permission to manage `~/.ssh/config`.
4. User selects a Codespace.
5. If Codespace is stopped, it is automatically started.
6. Extension generates SSH configuration using GitHub CLI.
7. Extension merges config into `~/.ssh/config`.
8. Extension triggers Remote-SSH to connect.

### Subsequent Connections

- User selects the Codespace → connection opens instantly.

---

## Architecture

### Components

- **Activation Hook**
  - Registers commands.
  - Sets up “Connect to Codespace” entrypoints.

- **GH CLI Service**
  - Detects `gh` presence.
  - Runs codespace listing, state checks, and SSH config generation.
  - Validates GitHub authentication and scopes.

- **SSH Config Manager**
  - Reads and parses `~/.ssh/config`.
  - Detects extension-generated entries.
  - Replaces or appends Codespace entries safely.
  - Ensures idempotency.

- **Codespace UI Picker**
  - Shows a QuickPick list of available Codespaces.
  - Uses `gh codespace list --json` for metadata.

- **Remote-SSH Bridge**
  - Calls underlying VS Code / Cursor commands:
    - `opensshremotes.openEmptyWindowOnHost`
    - or `remote-ssh.connectToHost`

- **Optional Devcontainer Fixer**
  - Detects SSHD missing in Codespace.
  - Offers automatic edit of `.devcontainer/devcontainer.json`.

---

## Detailed Workflows

### 1. Checking for GitHub CLI

```ts
try {
  await exec("gh", ["--version"]);
} catch {
  showError("GitHub CLI not installed. Install it to enable Codespaces integration.");
}
```

### 2. Checking Authentication & Scopes

Run:

```
gh auth status --check
```

If it fails:

- If not logged in → prompt terminal: `gh auth login`.
- If missing scopes → prompt terminal:  
  `gh auth refresh -h github.com -s codespace,admin:public_key,read:org`.

### 3. Listing Codespaces

```
gh codespace list --json name,displayName,state,updatedAt,repository
```

Parse JSON and display QuickPick.

### 4. Starting a Codespace

```
gh codespace start -c <name>
```

Poll until state becomes “Available”.

### 5. Generating SSH Configuration

```
gh codespace ssh --config -c <name>
```

The output contains:

- Host entry  
- Hostname  
- ProxyCommand  
- IdentityFile  
- Port  
- Known_hosts entries  

### 6. Merging Into `~/.ssh/config`

- Preserve user content.
- Only modify blocks generated by this extension.
- Wrap generated block with:

```
# >>> Cursor Codespaces Extension (managed)
Host codespaces-...
  ...
# <<< Cursor Codespaces Extension
```

### 7. Connecting via Remote-SSH

```ts
vscode.commands.executeCommand(
  "opensshremotes.openEmptyWindowOnHost",
  hostName
);
```

This immediately opens Cursor connected to the Codespace.

---

## Optional Feature: Devcontainer SSHD Fix

If the CLI returns an SSHD error:

- Offer to open `.devcontainer/devcontainer.json`.
- Inject:

```json
"features": {
  "ghcr.io/devcontainers/features/sshd:1": {}
}
```

- Prompt user to commit + rebuild Codespace.

---

## Security Considerations

- Extension never accesses GitHub tokens directly.
- All authentication handled by `gh`'s secure OAuth flow.
- SSH config modifications are limited, clearly marked, and reversible.
- Users are explicitly prompted before first write to `~/.ssh/config`.

---

## Command Overview

### Primary Command

- `cursorCodespaces.connect`:  
  The main connect workflow.

### Internal Commands

- `cursorCodespaces.ensureGh`
- `cursorCodespaces.ensureScopes`
- `cursorCodespaces.pickCodespace`
- `cursorCodespaces.mergeSshConfig`
- `cursorCodespaces.connectHost`

---

## File Structure Example

```
extension/
  src/
    activate.ts
    ghService.ts
    sshConfig.ts
    codespacePicker.ts
    remoteSsh.ts
    devcontainerFixer.ts
  package.json
  README.md
  LICENSE
```

---

## What Cursor Should Build

- A production-quality extension implementing all listed workflows.
- Clean async/await Node code.
- Safe file manipulation.
- Precise handling of GitHub CLI output.
- Idempotent SSH config merges.
- Fully guided UX with minimal friction.

---

## End Result

Users get a **native-feeling Codespaces integration**:

- No terminal steps.
- No SSH knowledge required.
- No manual config editing.
- Just select → connect → code.

This design document is meant to be handed directly to Cursor IDE so it can generate the extension codebase for you.
